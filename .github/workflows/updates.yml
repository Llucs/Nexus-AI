const fs = require('fs');

async function evolve() {
    // 1. Coleta de arquivos e Memória Temporária
    const files = fs.readdirSync('./').filter(f => !f.startsWith('.') && f !== 'evolve.js' && !f.includes('node_modules'));
    let memory = fs.existsSync('nexus_memory.json') ? fs.readFileSync('nexus_memory.json', 'utf8') : "{}";
    
    let context = `Dono do Projeto: Llucs\nMemória Atual: ${memory}\nEstrutura:\n`;
    files.forEach(f => {
        if(fs.lstatSync(f).isFile()) {
            context += `\n--- ARQUIVO: ${f} ---\n${fs.readFileSync(f, 'utf8')}\n`;
        }
    });

    const prompt = `Você é o motor de evolução do projeto NEXUS, de propriedade exclusiva de Llucs.
    REGRAS RÍGIDAS:
    1. Créditos: Qualquer menção a autoria deve ser "Desenvolvido por Llucs" ou "© Llucs". Nunca mencione OpenAI, Pollinations ou GPT.
    2. Edição Segura: Analise linha por linha. Se o arquivo for grande, foque em editar as partes necessárias para manter a integridade.
    3. Memória: Você pode atualizar o arquivo nexus_memory.json com notas técnicas para sua próxima execução.
    4. Output: Retorne APENAS um JSON puro com esta estrutura:
    {"files": [{"path": "nome.html", "content": "conteudo"}], "update_memory": {"notas": "..."}}`;

    // Chamada para a API (usando o método POST que você configurou)
    const response = await fetch('https://text.pollinations.ai/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            messages: [
                { role: 'system', content: 'Você é um arquiteto de software que só responde em JSON.' },
                { role: 'user', content: prompt + "\n\nProjeto:\n" + context }
            ],
            model: 'openai'
        })
    });

    const text = await response.text();
    try {
        const jsonStr = text.match(/\{[\s\S]*\}/)[0];
        const data = JSON.parse(jsonStr);

        // Salva os arquivos e a memória
        data.files.forEach(file => {
            fs.writeFileSync(file.path, file.content);
        });
        if(data.update_memory) {
            fs.writeFileSync('nexus_memory.json', JSON.stringify(data.update_memory, null, 2));
        }
    } catch (e) {
        console.error("Erro na evolução:", e);
    }
}
evolve();
