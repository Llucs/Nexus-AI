name: Nexus AI Self-Evolution
on:
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install node-fetch@2

      - name: AI Evolution Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Usamos uma variÃ¡vel para evitar conflitos de interpolaÃ§Ã£o no Bash
          cat << 'EOF' > evolve.js
          const fs = require('fs');
          const path = require('path');
          const fetch = require('node-fetch');

          async function evolve() {
              try {
                  console.log("ðŸš€ Iniciando processo de evoluÃ§Ã£o Nexus AI...");
                  
                  const files = fs.readdirSync('./').filter(f => 
                      !f.startsWith('.') && 
                      f !== 'evolve.js' && 
                      !f.includes('node_modules') && 
                      fs.lstatSync(f).isFile() &&
                      (f.endsWith('.html') || f.endsWith('.css') || f.endsWith('.js'))
                  );
                  
                  let memory = {};
                  if (fs.existsSync('nexus_memory.json')) {
                      memory = JSON.parse(fs.readFileSync('nexus_memory.json', 'utf8'));
                  }

                  let context = "ProprietÃ¡rio: Llucs\n";
                  files.forEach(f => {
                      const content = fs.readFileSync(f, 'utf8');
                      context += `\n=== ARQUIVO: ${f} ===\n${content}\n`;
                  });

                  const prompt = `VocÃª Ã© o NEXUS CORE, uma IA de auto-evoluÃ§Ã£o. Dono: Llucs. 
                  Sua tarefa Ã© ler os arquivos abaixo e retornar um JSON com a versÃ£o Cyberpunk (neon, futurista) separada em index.html, style.css e script.js.
                  Retorne APENAS o JSON: {"files": [{"path": "index.html", "content": "..."}, ...], "update_memory": {...}}
                  Contexto: ${context}`;

                  console.log("ðŸŒ Solicitando evoluÃ§Ã£o...");
                  
                  // Pollinations API via POST (Simulando chat)
                  const response = await fetch('https://text.pollinations.ai/', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          messages: [
                              { role: 'system', content: 'VocÃª Ã© um programador sÃªnior que responde APENAS JSON puro.' },
                              { role: 'user', content: prompt }
                          ],
                          seed: 42
                      })
                  });

                  const text = await response.text();
                  let cleanText = text.replace(/```json|```/g, "").trim();
                  const data = JSON.parse(cleanText);

                  data.files.forEach(file => {
                      fs.writeFileSync(file.path, file.content);
                      console.log(`âœ… Arquivo ${file.path} atualizado.`);
                  });

                  if (data.update_memory) {
                      fs.writeFileSync('nexus_memory.json', JSON.stringify(data.update_memory, null, 2));
                  }
              } catch (error) {
                  console.error("ðŸ’¥ ERRO:", error.message);
                  process.exit(1);
              }
          }
          evolve();
          EOF
          
          node evolve.js

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Nexus AI Evolution: Design Cyberpunk por Llucs"
          title: "âš¡ NEXUS EVOLUTION: Tema Cyberpunk Aplicado"
          branch: nexus-ai-evolution
          base: main
