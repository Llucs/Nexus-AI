name: Nexus AI Self-Evolution
on:
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: AI Evolution Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > evolve.js
          const fs = require('fs');

          async function evolve() {
              const files = fs.readdirSync('./').filter(f => 
                  !f.startsWith('.') && 
                  f !== 'evolve.js' && 
                  !f.includes('node_modules') &&
                  f !== 'package.json'
              );
              
              let memory = "{}";
              if (fs.existsSync('nexus_memory.json')) {
                  memory = fs.readFileSync('nexus_memory.json', 'utf8');
              }
              
              let context = "Propriet√°rio: Llucs\n";
              context += "Mem√≥ria T√©cnica: " + memory + "\n";
              
              files.forEach(f => {
                  if (fs.lstatSync(f).isFile()) {
                      const content = fs.readFileSync(f, 'utf8');
                      context += "\nFILE [" + f + "]:\n" + content + "\n";
                  }
              });

              const prompt = "Voc√™ √© o sistema de auto-evolu√ß√£o do NEXUS. Dono: Llucs. Regras: 1. Cr√©ditos apenas para Llucs. 2. Analise os arquivos e fa√ßa melhorias precisas. 3. Retorne APENAS um JSON: {\"files\": [{\"path\": \"...\", \"content\": \"...\"}], \"update_memory\": {...}}";

              try {
                  const response = await fetch('https://text.pollinations.ai/', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          messages: [
                              { role: 'system', content: 'Voc√™ √© um arquiteto de software que s√≥ responde em JSON puro.' },
                              { role: 'user', content: prompt + "\n\nContexto:\n" + context }
                          ],
                          model: 'openai'
                      })
                  });

                  const text = await response.text();
                  const jsonStr = text.match(/\{[\s\S]*\}/)[0];
                  const data = JSON.parse(jsonStr);

                  data.files.forEach(file => {
                      fs.writeFileSync(file.path, file.content);
                  });
                  if (data.update_memory) {
                      fs.writeFileSync('nexus_memory.json', JSON.stringify(data.update_memory, null, 2));
                  }
              } catch (e) {
                  console.error("Erro:", e);
                  process.exit(1);
              }
          }
          evolve();
          EOF
          node evolve.js

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Evolu√ß√£o Nexus por Llucs"
          title: "ü§ñ Evolu√ß√£o Nexus [Llucs]"
          body: "Altera√ß√µes autom√°ticas focadas em performance e UI."
          branch: nexus-ai-updates
