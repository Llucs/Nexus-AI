name: Nexus AI Self-Evolution
on:
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install node-fetch@2

      - name: AI Evolution Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > evolve.js
          const fs = require('fs');
          const fetch = require('node-fetch');

          async function evolve() {
              try {
                  console.log("üöÄ Iniciando evolu√ß√£o via Nexus Core...");
                  
                  // Lendo os arquivos atuais para dar contexto
                  const files = fs.readdirSync('./').filter(f => 
                      (f.endsWith('.html') || f.endsWith('.css') || f.endsWith('.js')) && f !== 'evolve.js'
                  );
                  
                  let context = "Arquivos atuais do projeto de Llucs:\n";
                  files.forEach(f => {
                      context += `\n--- ${f} ---\n${fs.readFileSync(f, 'utf8')}\n`;
                  });

                  // Criando o prompt para evolu√ß√£o Cyberpunk
                  const prompt = `Aja como NEXUS CORE IA. Transforme o c√≥digo de Llucs em um sistema CYBERPUNK (Neon, futurista). 
                  Separe em 3 arquivos: index.html, style.css e script.js.
                  Retorne APENAS um JSON puro (sem markdown) no formato:
                  {"files": [{"path": "index.html", "content": "..."}, {"path": "style.css", "content": "..."}, {"path": "script.js", "content": "..."}]}
                  
                  PROJETO ATUAL:
                  ${context}`;

                  // Usando o m√©todo GET que funcionou no seu HTML
                  const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=openai&json=true`;
                  
                  console.log("üåê Conectando √† mente da colmeia...");
                  const response = await fetch(url);
                  const text = await response.text();

                  // Limpeza para garantir JSON puro
                  let cleanText = text.replace(/```json/g, "").replace(/```/g, "").trim();
                  const startIdx = cleanText.indexOf('{');
                  const endIdx = cleanText.lastIndexOf('}');
                  
                  if (startIdx === -1) throw new Error("JSON n√£o encontrado na resposta");
                  const data = JSON.parse(cleanText.substring(startIdx, endIdx + 1));

                  // Salvando a evolu√ß√£o
                  data.files.forEach(file => {
                      fs.writeFileSync(file.path, file.content);
                      console.log(`‚úÖ ${file.path} evolu√≠do.`);
                  });

                  console.log("‚ú® Evolu√ß√£o conclu√≠da com sucesso!");

              } catch (error) {
                  console.error("üí• Falha na evolu√ß√£o:", error.message);
                  process.exit(1);
              }
          }
          evolve();
          EOF

          node evolve.js

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ü§ñ Nexus AI: Upgrade Cyberpunk por Llucs"
          title: "‚ö° NEXUS EVOLUTION: Interface Refatorada"
          body: "Evolu√ß√£o autom√°tica da interface aplicada com sucesso. Desenvolvido por Llucs."
          branch: nexus-update
          base: main
