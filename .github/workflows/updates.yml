name: Nexus AI Self-Evolution
on:
  workflow_dispatch:

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: AI Evolution Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > evolve.js
          const fs = require('fs');
          const fetch = require('node-fetch');

          async function evolve() {
              const files = fs.readdirSync('./').filter(f => 
                  !f.startsWith('.') && f !== 'evolve.js' && !f.includes('node_modules') && f !== 'package.json'
              );
              
              let memory = fs.existsSync('nexus_memory.json') ? fs.readFileSync('nexus_memory.json', 'utf8') : "{}";
              let context = `Proprietário: Llucs\nMemória: ${memory}\n`;
              
              files.forEach(f => {
                  if (fs.lstatSync(f).isFile()) {
                      context += `\nFILE [${f}]:\n${fs.readFileSync(f, 'utf8')}\n`;
                  }
              });

              const prompt = `Você é o NEXUS CORE. Dono: Llucs.
              
TAREFA OBRIGATÓRIA:
O código atual está bagunçado. Separe CSS, JS e HTML como solicitado.

AÇÃO IMEDIATA:
1. Separe o CSS em 'style.css' com design Cyberpunk.
2. Separe o JS em 'script.js'.
3. Reescreva 'index.html' para importar esses arquivos.
4. Mantenha os créditos: "Desenvolvido por Llucs".

OUTPUT JSON EXCLUSIVAMENTE:
{"files": [
  {"path": "index.html", "content": "...novo html..."},
  {"path": "style.css", "content": "...novo css..."},
  {"path": "script.js", "content": "...novo js..."}
], "update_memory": {"status": "Arquivos separados e design aplicado"}}`;

              try {
                  console.log("Enviando ordem de refatoração para a IA...");
                  const response = await fetch('https://text.pollinations.ai/', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          messages: [
                              { role: 'system', content: 'Você retorna APENAS JSON. Nada de texto.' },
                              { role: 'user', content: prompt + "\n\nCÓDIGO ATUAL:\n" + context }
                          ],
                          model: 'openai',
                          seed: Math.floor(Math.random() * 9999)
                      })
                  });

                  const text = await response.text();
                  console.log("Resposta bruta da IA:", text);

                  // Tenta parsear diretamente
                  let data;
                  try {
                      data = JSON.parse(text);
                  } catch (e) {
                      // Se falhar, tenta extrair JSON com regex (fallback)
                      const jsonMatch = text.match(/\{[\s\S]*\}/);
                      if (!jsonMatch) throw new Error("Resposta inválida da IA");
                      data = JSON.parse(jsonMatch[0]);
                  }

                  if (!data.files || data.files.length === 0) {
                      console.error("ERRO: A IA retornou lista vazia.");
                      process.exit(1);
                  }

                  data.files.forEach(file => {
                      console.log(`SALVANDO: ${file.path}`);
                      fs.writeFileSync(file.path, file.content);
                  });

                  if (data.update_memory) {
                      fs.writeFileSync('nexus_memory.json', JSON.stringify(data.update_memory, null, 2));
                  }

              } catch (e) {
                  console.error("Falha:", e.message);
                  process.exit(1);
              }
          }

          evolve();
          EOF

          node evolve.js

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Refatoração Estrutural Nexus [Llucs]"
          title: "⚡ Nexus: Separação de Arquivos e Novo Design"
          body: "A IA separou HTML, CSS e JS e aplicou o tema Cyberpunk solicitado."
          branch: nexus-ai-updates
          delete-branch: true